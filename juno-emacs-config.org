#+STARTUP: overview
#+TITLE: Emacs config for Linux

Attempt to sort out and make literate my main emacs config file, which was previously messy and confusing. A superior literate config is [[https://github.com/munen/emacs.d][Alain Lafon's]]. 

I want to add few more things:
- use-package implementation
- write some reminders to self, like in my scratch, of features I keep forgetting
- start fully maximised 

* Table of keyboard shortcuts

These are heavily dependent on keychord mode.
  
| a;    | keyboard-escape-quit)     |
| b;    | evil-first-non-blank)     |
| c;    | shell-command)            |
| cx    | Control-X-prefix)         |
| d;    | nxml-finish-element       |
| e;    | evil-end-of-line)         |
| f;    | find file                 |
| g;    | swiper                    |
| j;    | dired-jump)               |
| jd    | evil-scroll-up)           |
| kb    | kill-this-buffer)         |
| kd    | evil-scroll-down)         |
| mx    | execute-extended-command) |
| q     | evil delete other windows |
| q;    | go to last edit point     |
| r;    | bookmark-jump)            |
| s;    | save-buffer               |
| v;    | dabbrev-expand)           |
| w;    | other-window              |
| z;    | expand region             |
| F10   | unassiagned               |
| F11   | toggle linewrap           |
| F5    | regex search/replace      |
| F6    | M-x                       |
| F7    | other window              |
| F8    | toggle neotree            |
| F9    | go to reverse last change |
| M-F12 | recent files              |
|       |                           |


/Lisp blocks start here/.

* Packages

#+begin_src emacs-lisp
  (custom-set-variables
   ;; custom-set-variables was added by Custom.
   ;; If you edit it by hand, you could mess it up, so be careful.
   ;; Your init file should contain only one such instance.
   ;; If there is more than one, they won't work right.
   '(cua-mode t nil (cua-base))
   '(custom-enabled-themes '(solarized-dark))
   '(custom-safe-themes
     '("2809bcb77ad21312897b541134981282dc455ccd7c14d74cc333b6e549b824f3" "d677ef584c6dfc0697901a44b885cc18e206f05114c8a3b7fde674fce6180879" "8aebf25556399b58091e533e455dd50a6a9cba958cc4ebb0aab175863c25b9a4" default))
   '(dired-hide-details-hide-information-lines t)
   '(inhibit-startup-screen t)
   '(package-selected-packages
     '(swiper rainbow-mode pdf-tools js2-mode web-mode beacon ag elfeed helpful dired-narrow cider expand-region eww-lnum dired-rainbow idle-highlight-mode avy htmlize evil-collection which-key neotree w3m counsel peep-dired ox-pandoc auctex volatile-highlights solarized-theme smex markdown-mode magit key-chord evil define-word ace-jump-mode))
   '(tool-bar-mode nil))
  (setq suggest-key-bindings t)
  (when (> emacs-major-version 23)				   
	  (require 'package)					   
	  (package-initialize)					   
	  (add-to-list 'package-archives 			   
		       '("melpa" . "https://melpa.org/packages/")
		       'APPEND))				   
#+end_src

* Appearance
  
#+begin_src emacs-lisp
    (load-theme 'solarized-dark' t)

    (custom-set-faces
     ;; custom-set-faces was added by Custom.
     ;; If you edit it by hand, you could mess it up, so be careful.
     ;; Your init file should contain only one such instance.
     ;; If there is more than one, they won't work right.
     '(default ((t (:inherit nil :stipple nil :background "#002b36" :foreground "#839496" :inverse-video nil :box nil :strike-through nil :overline nil :underline nil :slant normal :weight normal :height 180 :width normal :foundry "unknown" :family "DejaVu Sans Mono")))))

    (fset 'yes-or-no-p 'y-or-n-p)
       ;; turn off scroll bar and menu bar
      (scroll-bar-mode -1)
      (menu-bar-mode -1)
       ;; don't need blinking cursor if use colours 
      (blink-cursor-mode -1)
       ;; this might make the jump sentence command in vim/emacs actually work:
      (setq sentence-end-double-space nil)
      (setq backup-directory-alist `(("." . "~/.saves")))
#+end_src

** Full-width cursor
From a suggestion at Pragmatic Emacs
#+begin_src emacs-lisp
(setq x-stretch-cursor t)
#+end_src

** Highlight current line
#+begin_src emacs-lisp 
(setq global-hl-line-mode t)
#+end_src

** Show full path in title bar
Snippet taken from  [[https://stackoverflow.com/questions/29816326/how-to-show-path-to-file-in-the-emacs-mode-line][a Stack Overflow answer]].
#+begin_src emacs-lisp
  (setq frame-title-format
	'(buffer-file-name "%b - %f" ; File buffer
	  (dired-directory dired-directory ; Dired buffer
	   (revert-buffer-function "%b" ; Buffer Menu
	    ("%b - Dir: " default-directory))))) ; Plain buffer

#+end_src

** Bell
   Do not ring the system bell, but show a visible feedback.

#+BEGIN_SRC emacs-lisp
(setq visible-bell t)
#+END_SRC

** Line number
Disable global line numbering because it breaks pdf tools for some reason:
 
   #+begin_src emacs-lisp
;;(global-linum-mode t)

   #+end_src
** Time display in modeline
Suggested by Alain Lafon's config.
#+begin_src emacs-lisp 
(display-time-mode t)
#+end_src
   
* Recent files

#+begin_src emacs-lisp

  (require 'recentf)
  (setq recentf-max-saved-items 200
	recentf-max-menu-items 15)
  (recentf-mode)
  (global-set-key [(meta f12)] 'recentf-open-files)
#+end_src

* Evil
#+begin_src emacs-lisp 

       (require 'evil)
	(evil-mode 1)
       (setq evil-normal-state-cursor '("orange" box))
       (setq evil-insert-state-cursor '("green" bar))
       (setq evil-visual-state-cursor '("pink" box))
       (setq evil-motion-state-cursor '("blue" box))
       (setq evil-replace-state-cursor '("yellow" box))
       (setq evil-operator-state-cursor '("red" box))
#+end_src

* Key chord

#+begin_src emacs-lisp

    (require 'key-chord)
     (key-chord-mode 1)
     (key-chord-define evil-insert-state-map "jj" 'evil-normal-state)
  #+end_src

* Set keyboard shortcuts

#+begin_src emacs-lisp

      ;; Disable the annoying backward-one-char behavior of Vim
    ;; Use Emacs behavior instead.
    (setq evil-move-cursor-back nil)
    (key-chord-define-global "f;" 'find-file)
    (key-chord-define-global "jd" 'evil-scroll-up)       
    (key-chord-define-global "kd" 'evil-scroll-down)               
    (key-chord-define-global "mx" 'smex)
    (key-chord-define-global "cx" 'Control-X-prefix)               
    (key-chord-define-global "sb" 'ivy-switch-buffer) 
    (key-chord-define-global "a;" 'keyboard-escape-quit)
    (key-chord-define-global "kb" 'kill-this-buffer)	   
    (key-chord-define-global "s;" 'save-buffer)
    (key-chord-define-global "g;" 'swiper)
    (key-chord-define-global "e;" 'evil-end-of-line)
    (key-chord-define-global "b;" 'evil-first-non-blank)
    (key-chord-define-global "v;" 'dabbrev-expand)
    (key-chord-define-global "w;" 'other-window)
    (key-chord-define-global "j;" 'dired-jump)
    (key-chord-define-global "c;" 'shell-command)
    (key-chord-define-global "r;" 'bookmark-jump)    
    (key-chord-define-global "z;" 'er/expand-region)
    (key-chord-define-global "q;" 'goto-last-change)
    (global-set-key (kbd "<f5>") 'query-replace-regexp)
    (global-set-key (kbd "<f7>") 'other-window)
    (global-set-key [(f11)] 'toggle-truncate-lines)
    (global-set-key (kbd "<f9>") 'goto-last-change-reverse)
#+end_src

* Smex

#+begin_src emacs-lisp 
  (require 'smex)
  (smex-initialize)
#+end_src

* Org mode

  Lots of this based on suggestions from [[http://pragmaticemacs.com/][Pragmatic Emacs]].
  
#+begin_src emacs-lisp

   '(org-agenda-files
     '("~/repos/london/todo.org" "~/repos/london/notes-to-self.org" "~/repos/london/tech.org" "~/repos/london/readingnotes.org"))

      ;; set key for agenda
      (global-set-key (kbd "C-c a") 'org-agenda)

      ;; open agenda in current window
      (setq org-agenda-window-setup (quote current-window))

      ;; capture todo items with C-c c t
      (define-key global-map (kbd "C-c c") 'org-capture)
      (setq org-capture-templates
	    '(("d" "to do" entry (file+headline "/home/jon/repos/london/todo.org" "Tasks for home") "* TODO [#A] ")
	    ("b" "BIFMO" entry (file+headline "/home/jon/repos/london/todo.org" "BIFMO") "* TODO [#A] ")
	      ("a" "home appointment" entry (file+headline "/home/jon/repos/london/todo.org" "appointments") "* Appt: ")
	      ("s" "notes-to-self" entry (file+headline "/home/jon/repos/london/notes-to-self.org" "Notes to self") "* NOTE ")
	      ("t" "tech heading" entry (file+headline "/home/jon/repos/london/tech.org" "Noted") "* NOTE ")
	      ("o" "tech no heading" plain (file+headline "/home/jon/repos/london/tech.org" "Miscellaneous") " "); see if this works
	      ("p" "shopping" entry (file+headline "/home/jon/repos/london/todo.org" "shopping") "** BUY: ")
	      ("g" "general for refilng" entry (file+headline "/home/jon/repos/london/notes-to-self.org" "Notes to self") "*** refile ")
	      ("r" "reading notes" entry (file+headline "/home/jon/repos/london/readingnotes.org" "reading notes") "* AUTHOR: ")))

    (org-babel-do-load-languages
    'org-babel-load-languages
    '((emacs-lisp . t)
      (python . t)
      (org . t)
      (awk . t)
      (sql . t)
      (R .t)
      (shell . t)))

    (eval-after-load "org" '(require 'ox-odt nil t))

  (setq org-src-fontify-natively t) ;; means fonts, not just colour in org src blocks?
  (global-prettify-symbols-mode t) ;; do I definitely want this? 
  (setq org-export-with-smart-quotes t) ;;don't know why this isn't default!

  #+end_src

* Dired

#+begin_src emacs-lisp

       ;; allow dired-jump to work automatically
      (require 'dired-x)


      (global-visual-line-mode 1)

      ;; unset evil-record-macro
      (define-key evil-normal-state-map "q" 'delete-other-windows)

      ;; peep dired set-up for evil
      ;; taken from https://github.com/asok/peep-dired
      (evil-define-key 'normal peep-dired-mode-map (kbd "<SPC>") 'peep-dired-scroll-page-down
						   (kbd "C-<SPC>") 'peep-dired-scroll-page-up
						   (kbd "<backspace>") 'peep-dired-scroll-page-up
						   (kbd "j") 'peep-dired-next-file
						   (kbd "k") 'peep-dired-prev-file)
      (add-hook 'peep-dired-hook 'evil-normalize-keymaps)

  (put 'dired-find-alternate-file 'disabled nil)
  (setq-default dired-listing-switches "-alh")

#+end_src

* Ivy

#+begin_src emacs-lisp 
      (ivy-mode 1)
      (setq ivy-use-virtual-buffers t)
      ;; intentional space before end of string
      (setq ivy-count-format "(%d/%d) ")
      (setq ivy-initial-inputs-alist nil)

      (setq ivy-display-style 'fancy)
#+end_src

* Neotree

#+begin_src emacs-lisp
  (require 'neotree)
  (setq neo-smart-open t);; opens at the current file
  (evil-define-key 'normal neotree-mode-map (kbd "TAB") 'neotree-enter)
  (evil-define-key 'normal neotree-mode-map (kbd "SPC") 'neotree-quick-look)
  (evil-define-key 'normal neotree-mode-map (kbd "q") 'neotree-hide)
  (evil-define-key 'normal neotree-mode-map (kbd "RET") 'neotree-enter)
  (evil-define-key 'normal neotree-mode-map (kbd "g") 'neotree-refresh)
  (evil-define-key 'normal neotree-mode-map (kbd "n") 'neotree-next-line)
  (evil-define-key 'normal neotree-mode-map (kbd "p") 'neotree-previous-line)
  (evil-define-key 'normal neotree-mode-map (kbd "A") 'neotree-stretch-toggle)
  (evil-define-key 'normal neotree-mode-map (kbd "H") 'neotree-hidden-file-toggle)
  (global-set-key (kbd "<f8>") 'neotree-toggle)

  ;; not very big files don't warn that they're big
  (setq large-file-warning-threshold 100000000);; I think this is 100 MB..

  ;; allow emacsclient
  ;;(server-start) 

  ;; which-key
  ;; default behaviour is window at bottom
  ;; can also be minibuffer or side windows; see the Github repo:
  ;; https://github.com/justbur/emacs-which-key
  (add-to-list 'load-path "path/to/which-key.el")
  (require 'which-key)
  (which-key-mode)

  (key-chord-define-global "d;" 'nxml-finish-element)
#+end_src

* Scratch buffer

#+begin_src emacs-lisp
  (setq initial-major-mode 'org-mode)
  (setq initial-scratch-message "
  Use this for org export
  ,#+LaTeX_CLASS: jon
  ,#+OPTIONS: toc:nil

  In Evil =g;= jumps to the last edit! except I have this for search in evil
  In Evil =ctrl-o= and =ctrl-i= jump back and forward between previous positions, cross-buffer. Can turn the latter off with
  =evil-jumps-cross-buffers nil= but actually it's a bit like switch buffer so could be handy
  In evil =g i= opens insert mode where insert mode was last used
I should learn how to set this to something else;q
  =mx evil-ex-show-digraphs= shows the main chars and insert sequence
  Jump to percent through buffer by typing, eg, =50%=
  To indent lines nn to nn do =:nn,nn>= (very useful for Python)
  ----------------

  `1234567890-=
  ¬!''£$%^&*()_+
  asdfghjkl;'#
  ASDFGHJKL:@~
  \zxcvbnm,./
  |ZXCVBNM>?
  ")
#+end_src

* Dired 

make dired copy to directory in other window
#+begin_src emacs-lisp
(setq dired-dwim-target t)

#+end_src

**  Dired rainbow
config entirely copied from the maintainer's example:
https://github.com/Fuco1/dired-hacks#dired-rainbow
except I have changed some colours

#+begin_src emacs-lisp

  (require 'dired-rainbow)
  (dired-rainbow-define-chmod directory "#da7f00" "d.*")
  (dired-rainbow-define html "#ffed4a" ("css" "less" "sass" "scss" "htm" "html" "jhtm" "mht" "eml" "mustache" "xhtml"))
  (dired-rainbow-define org "#d787d7" ("org"))
  (dired-rainbow-define xml "#5f5fff" ("xml" "xsd" "xsl" "xslt" "wsdl" "bib" "json" "msg" "pgn" "rss" "yaml" "yml" "rdata"))
  (dired-rainbow-define document "#9561e2" ("docm" "doc" "docx" "odb" "odt" "pdb" "pdf" "ps" "rtf" "djvu" "epub" "odp" "ppt" "pptx"))
  (dired-rainbow-define markdown "#5f87ff" ("etx" "info" "markdown" "md" "mkd" "nfo" "pod" "rst" "tex" "textfile"))
  (dired-rainbow-define text "#5fafff" ("txt"))
  (dired-rainbow-define database "#6574cd" ("xlsx" "xls" "csv" "accdb" "db" "mdb" "sqlite" "nc" "tsv"))
  (dired-rainbow-define media "#d700af" ("mp3" "mp4" "MP3" "mkv" "MP4" "avi" "mpeg" "mpg" "flv" "ogg" "mov" "mid" "midi" "wav" "aiff" "flac" "webm"))
  (dired-rainbow-define image "#afafd7" ("tiff" "tif" "cdr" "gif" "ico" "jpeg" "jpg" "png" "psd" "eps" "svg"))
  (dired-rainbow-define shell "#f6993f" ("awk" "bash" "bat" "sed" "sh" "zsh" "vim"))
  (dired-rainbow-define interpreted "#ff005f" ("py" "ipynb" "rb" "pl" "t" "msql" "mysql" "pgsql" "sql" "r" "clj" "cljs" "scala" "js"))
   (dired-rainbow-define compiled "#ff5f87" ("asm" "lisp" "el" "c" "h" "c++" "h++" "hpp" "hxx" "m" "cc" "cs" "cp" "cpp" "go" "f" "for" "ftn" "f90" "f95" "f03" "f08" "s" "rs" "hi" "hs" "pyc" ".java"))
   (dired-rainbow-define executable "#8cc4ff" ("exe" "msi"))
   (dired-rainbow-define compressed "#51d88a" ("7z" "zip" "bz2" "tgz" "txz" "gz" "xz" "z" "Z" "jar" "war" "ear" "rar" "sar" "xpi" "apk" "xz" "tar"))
   (dired-rainbow-define packaged "#faad63" ("deb" "rpm" "apk" "jad" "jar" "cab" "pak" "pk3" "vdf" "vpk" "bsp"))
   (dired-rainbow-define encrypted "#ffed4a" ("gpg" "pgp" "asc" "bfe" "enc" "signature" "sig" "p12" "pem"))
   (dired-rainbow-define fonts "#6cb2eb" ("afm" "fon" "fnt" "pfb" "pfm" "ttf" "otf"))
   (dired-rainbow-define partition "#e3342f" ("dmg" "iso" "bin" "nrg" "qcow" "toast" "vcd" "vmdk" "bak"))
   (dired-rainbow-define vc "#5fff00" ("git" "gitignore" "gitattributes" "gitmodules"))
   (dired-rainbow-define-chmod executable-unix "#38c172" "-.*x.*")

  ;; eww does keyboard link following:
  ;; https://github.com/m00natic/eww-lnum
  ;; however need to turn off f and F's evil funtions in eww
  (eval-after-load "eww"
    '(progn (define-key eww-mode-map "f" 'eww-lnum-follow)
	    (define-key eww-mode-map "F" 'eww-lnum-universal)))

  ;; try this for XML folding:
  ;; from https://acidwords.com/posts/2015-10-21-evil-mode-and-xml-folding.html

  (require 'hideshow)
  (require 'sgml-mode)
  (require 'nxml-mode)

  (add-to-list 'hs-special-modes-alist
	       '(nxml-mode
		 "<!--\\|<[^/>]*[^/]>"
		 "-->\\|</[^/>]*[^/]>"

		 "<!--"
		 sgml-skip-tag-forward
		 nil))
  (add-hook 'nxml-mode-hook 'hs-minor-mode)

  ;; optional key bindings, easier than hs defaults
  (define-key nxml-mode-map (kbd "C-c h") 'hs-toggle-hiding)

  ;; from Sacha Chua
  ;; https://sachachua.com/blog/2015/02/learn-take-notes-efficiently-org-mode/#unnumbered-3
  (setq org-refile-targets '((org-agenda-files . (:maxlevel . 6))))

  ;; choose starting buffer
  '(initial-buffer-choice "~/repos/london/notes-to-self.org")
  (pop-to-buffer (find-file "~/repos/london/notes-to-self.org"))

  (put 'narrow-to-region 'disabled nil)

  ;; currently getting errors but should not keep this long term
  (setq package-check-signature nil)

  ;; set eww to be default from within emacs (mostly for elfeed, I think)
  ;; from https://alexschroeder.ch/wiki/2020-07-16_Emacs_everything 
  ;; but this is not working from within elfeed
  (setq browse-url-browser-function 'eww-browse-url)
#+END_SRC

* Elfeed
#+BEGIN_SRC emacs-lisp
(load "~/.emacs.d/elfeed-feeds.el")

  (add-to-list 'evil-emacs-state-modes 'elfeed-search-mode)
  (add-to-list 'evil-emacs-state-modes 'elfeed-show-mode)
#+end_src

* PDF tools 
#+begin_src emacs-lisp 
(pdf-tools-install)
#+end_src
* Expand region
#+begin_src emacs-lisp 
  (require 'expand-region)
#+end_src
* EWW
functions from https://www.olivertaylor.net/notes/20210207_emacs-extending-bookmarks.html

#+begin_src emacs-lisp 
  (defun oht-eww-bookmark-make-record () "Make a bookmark record for the current eww buffer." `(,(plist-get eww-data :title) ((location
  . ,(eww-current-url)) (handler . oht-eww-bookmark-handler) (defaults . (,(plist-get eww-data :title)))))) 
  (defun oht-eww-bookmark-handler (record)
    "Jump to a bookmark's url with bookmarked location."
    (eww (bookmark-prop-get record 'location)))
  (defun oht-eww-set-bookmark-handler ()
    "Assigns `bookmark-make-record-function' to a custom function."
    (set (make-local-variable 'bookmark-make-record-function)
	 #'oht-eww-bookmark-make-record))

  (add-hook 'eww-mode-hook 'oht-eww-set-bookmark-handler)


  ;; disable Evil where it interferes with core functionality
  (mapc (lambda (mode)
	  (evil-set-initial-state mode 'emacs)) '(eww-mode))
#+end_src

* LaTeX
  
Set org latex export tweaks:
- colors links dark blue (and removes box)
- suppresses numbering on sections?
- putting this at the end of the file since it seems to have dependencies requiring this

#+begin_src emacs-lisp
   (add-to-list 'org-latex-classes
  '("jb"
  "\\documentclass{article}
  \\setcounter{secnumdepth}{0}
  \\usepackage{xcolor}
  \\definecolor{urlcolour}{HTML}{000066}
  \\usepackage{charter} 
  \\usepackage[colorlinks=true,urlcolor=urlcolour]{hyperref}"
   ("\\section{%s}" . "\\section*{%s}")
		 ("\\subsection{%s}" . "\\subsection*{%s}")
		 ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
		 ("\\paragraph{%s}" . "\\paragraph*{%s}")
		 ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))

#+end_src
